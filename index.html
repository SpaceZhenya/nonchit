<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Быстрый Веб-ИИ: чат</title>
  <style>
    /* то же оформление, опущено ради компактности */
  </style>
</head>
<body>
  <div class="chat-container">
    <div id="chat-box" class="chat-box"></div>
    <div class="input-group">
      <input id="user-input" type="text" placeholder="Напиши сообщение…"/>
      <button id="send-btn">Отправить</button>
    </div>
  </div>

  <script type="module">
    import {
      pipeline,
      env
    } from "https://cdn.jsdelivr.net/npm/@xenova/transformers@2.5.0/dist/transformers.min.js";

    // 1) Отключаем загрузку моделей из удалённых источников
    env.allowRemoteModels = false;

    // 2) Указываем, где лежат локальные WASM- и ONNX-файлы (предварительно скачанные и закопированные в /models/)
    env.backends.onnx.wasm.wasmPaths = "/models/onnx-wasm/";

    // 3) Загружаем облегчённую квантованную версию distilgpt2 в формате ONNX
    //    (файлы: /models/distilgpt2/config.json, tokenizer.json, onnx/model_quantized.onnx и .wasm)
    const generator = await pipeline("text-generation", "Xenova/distilgpt2", {
      modelType: "onnx"
    });

    const chatBox = document.getElementById("chat-box");
    const userInput = document.getElementById("user-input");
    const sendBtn   = document.getElementById("send-btn");

    function appendMessage(text, role) {
      const div = document.createElement("div");
      div.classList.add("message", role);
      div.textContent = text;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function sendMessage() {
      const msg = userInput.value.trim();
      if (!msg) return;
      appendMessage(msg, "user");
      userInput.value = "";
      sendBtn.disabled = true;

      // Генерируем ответ
      const out = await generator(msg, {
        max_new_tokens: 80,
        temperature: 0.7,
        return_full_text: false
      });

      appendMessage(out[0].generated_text.trim(), "assistant");
      sendBtn.disabled = false;
    }

    sendBtn.addEventListener("click", sendMessage);
    userInput.addEventListener("keydown", e => {
      if (e.key === "Enter") sendMessage();
    });
  </script>
</body>
</html>
